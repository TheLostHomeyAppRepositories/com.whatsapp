<html>

<head>
    <link rel="stylesheet" href="./output.css">
    <style>
        :root {
            background-color: var(--homey-color-mono-025) !important;
            color: var(--homey-color-mono-1000) !important;
        }

        .homey-widget-full {
            padding-bottom: var(--homey-su-4);
            overflow-x: hidden !important;
            overflow-y: auto !important;
        }

        .chat-bubble {
            background-color: var(--homey-color-mono-000);
            color: var(--homey-color-mono-1000);
            font-size: var(--homey-font-size-small);
            min-height: 2.25rem;
            min-width: 2.25rem
        }

        .homey-dark-mode .chat-bubble {
            background-color: var(--homey-color-mono-100) !important;
        }

        .chat-header {
            color: var(--homey-color-mono-1000) !important;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .avatar-green {
            background-color: var(--homey-color-green-300);
            color: #1d1d1d;
        }

        .avatar-blue {
            background-color: var(--homey-color-blue-200);
            color: #1d1d1d;
        }
    </style>
</head>

<body id="chat" class="homey-widget-full">
    <span id="loading" class="loading loading-ring loading-lg"></span>
    <script type="text/javascript" src="./helpers.js"></script>

    <script type="text/javascript">
        // globalVars
        let inviteCode = null;
        let widgetInitialized = false;
        let clearInitialMessage = false;

        function onHomeyReady (Homey) {
            const settings = Homey.getSettings();

            Homey.ready({ height: settings.widgetHeight || 600 });

            // NextTick to make sure the Homey object is ready
            setTimeout(() => {
                checkRequirements(Homey);
                initChatListener(Homey);
            }, 1000);

        }

        function renderDate (timestamp) {
            const date = new Date(timestamp);
            // Format the date in DD-MM-YYYY
            const optionsDate = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const shortDate = date.toLocaleDateString('nl-Nl', optionsDate); // 'en-GB' for day-month-year format

            // Format the time in 24-hour format
            const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false };
            const shortTime = date.toLocaleTimeString('nl-NL', optionsTime);

            return `${shortDate} ${shortTime}`;
        }

        function checkRequirements (Homey) {
            try {
                const settings = Homey.getSettings();
                const widgetId = Homey.getWidgetInstanceId()
                const deviceId = getDeviceId(Homey);
                const dataId = settings.dataId || "";

                if (!deviceId) {
                    console.log('No inviteCode set in store');
                    parseMessage({ text: `${Homey.__('widget.no_device')} <br /><br /><br />`, fromMe: false, timeStamp: Date.now(), from: 'Whatsapp Widget', hasImage: false, base64Image: null }, settings, true);
                    hideLoader();
                }

                if (!dataId || dataId === "" || dataId.length < 1) {
                    console.log('No dataId set in settings');
                    parseMessage({ text: `${Homey.__('widget.no_number')} <br /><br /><br />`, fromMe: false, timeStamp: Date.now(), from: 'Whatsapp Widget', hasImage: false, base64Image: null }, settings, true);
                    hideLoader();
                }

                if (deviceId && dataId && dataId.length > 1) {
                    console.log('Device and dataId found, setting up widget chat instance', { deviceId, dataId, widgetId });
                    Homey.api('POST', `/setWidgetInstance`, { widgetId: widgetId, dataId: dataId, deviceId: deviceId }).then((response) => {
                        console.log('Set widget chat instance response:', response);

                        getWidgetInstance(Homey);
                    }).catch((error) => {
                        console.error('Failed to set widget chat instance:', error);
                    });
                }
            } catch (error) {
                console.error('Failed to get initial chat:', error);
            }
        }

        function getWidgetInstance (Homey) {
            const settings = Homey.getSettings();
            const widgetId = Homey.getWidgetInstanceId()
            const deviceId = getDeviceId(Homey);
            const dataId = settings.dataId || "";

            Homey.api('POST', `/getWidgetInstance`, { widgetId: widgetId, dataId: dataId, deviceId: deviceId }).then((messages) => {
                console.log('Received chats:', messages);

                if (messages && messages.length > 0) {
                    messages.forEach((msg) => {
                        parseMessage(msg, settings);
                    });

                    hideLoader();

                    setTimeout(() => {
                        const chat = document.getElementById('chat');
                        chat.scrollTop = chat.scrollHeight;
                    }, 1000);
                } else {
                    console.log('No messages found');
                    parseMessage({ text: `${Homey.__('widget.no_chat')} <br /><br /><br />`, fromMe: false, timeStamp: Date.now(), from: 'Whatsapp Widget', hasImage: false, base64Image: null }, settings, true);
                    clearInitialMessage = true;
                    hideLoader();
                }
            }).catch((error) => {
                console.error('Failed to get chat messages:', error);
            });
        }

        function hideLoader () {
            widgetInitialized = true;

            document.getElementById('loading').style.display = 'none';
        }

        function getDeviceId (Homey) {
            const deviceIds = Homey.getDeviceIds()
            return deviceIds && deviceIds.length > 0 ? deviceIds[0] : null;
        }

        function initChatListener (Homey) {
            const settings = Homey.getSettings();
            const widgetId = Homey.getWidgetInstanceId()
            const deviceId = getDeviceId(Homey)

            Homey.on(`${deviceId}-chat`, (data) => {
                console.log('Received data:', data);
                // Check if the inviteCode is set and the message is from the group
                // If so, parse the message
                const samedeviceId = data.deviceId === deviceId;
                const sameDataId = data.dataId === settings.dataId;
                console.log(`check validity`, { widgetDeviceId: deviceId, dataDeviceId: data.deviceId, widgetInitialized, samedeviceId, widgetDataId: settings.dataId, dataDataId: data.dataId, sameDataId });
                if (widgetInitialized && samedeviceId && sameDataId) {
                    parseMessage(data, settings);
                } else {
                    console.log('Skip message parse, not for this device/widget or not initialized yet');
                }
            });
        }

        function parseMessage (data, settings, isSetup = false) {
            const { invertChat, showFromMe, showFromOthers, fromMeName } = settings;

            if (clearInitialMessage) {
                document.getElementById('chat').innerHTML = '';
                clearInitialMessage = false;
            }

            const {
                text,
                from,
                fromMe = false,
                timeStamp,
                hasImage = false,
                base64Image = false
            } = data;
            const isFromMe = invertChat ? !fromMe : fromMe;
            const image = base64Image;
            const chatClass = isFromMe ? 'chat-end' : 'chat-start';
            const background = isFromMe ? 'avatar-blue' : 'avatar-green';

            const hideMessageFromOthers = !fromMe && !showFromOthers;
            const hideMessageFromMe = fromMe && !showFromMe;
            const hideEmptyMessage = !text || text === '' | !!text.length < 1;

            if (hideMessageFromOthers || hideMessageFromMe || hideEmptyMessage) {
                return;
            }

            let chat = document.getElementById('chat');
            chat.innerHTML += `
                    <div class="chat ${chatClass}">
                    <div class="chat-image avatar placeholder">
                    <div class="w-10 rounded-full ${background}">
                        <span class="text-3xl">${fromMe ? fromMeName.substring(0, 1) : from.substring(0, 1)}</span>
                    </div>
                    </div>
                    <div class="chat-header">${fromMe ? fromMeName : from}
                    <time class="text-xs opacity-50">${renderDate(timeStamp)}</time>
                    </div>
                    <div class="chat-bubble">
                        ${hasImage ? `<img alt="${fromMe ? fromMeName : from}" src="${image}" />` : ''}
                        
                        ${formatText(text)}</div>
                </div>
                `;


            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>

</html>